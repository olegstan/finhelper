{"version":3,"file":"UserValuation.js","names":["moment","Cache","Active","InvestCalc","IndexedDBCache","Api","ReactComponentEmulator","state","setState","param","callback","UserValuation","getAccountValuation","array","sum","getWholeActivesSum","getValuation","invests","getInvestActivesSum","getInvestActivesValuation","managerId","clientId","currencyId","accountBanks","courses","atonValuation","Promise","resolve","reject","get","setDomain","process","env","REACT_APP_API_WHITESWAN_URL","where","all","data","map","row","score_position_rub","component","accounts","actives","properties","spendings","obligations","cashBalance","bankBalance","brokerBalance","digitBalance","cachedValue","now","currencyData","currency_id","user_id","getAccountsByDate","getInvestsByDate","valuation","setItem"],"sources":["../../src/helpers/UserValuation.js"],"sourcesContent":["import moment from \"moment/moment\";\r\nimport Cache from \"./Cache\";\r\nimport Active from \"./Active\";\r\nimport InvestCalc from \"./InvestCalc\";\r\nimport IndexedDBCache from \"./IndexedDBCache\";\r\nimport {Api} from \"laravel-request\";\r\n\r\nclass ReactComponentEmulator\r\n{\r\n  state = {};\r\n\r\n  setState(param, callback)\r\n  {\r\n    if (typeof param === 'function')\r\n    {\r\n      this.state = param(this.state);\r\n    } else if (typeof param === 'object')\r\n    {\r\n      this.state = param;\r\n    }\r\n\r\n    if (typeof callback === 'function')\r\n    {\r\n      callback();\r\n    }\r\n  }\r\n}\r\n\r\nexport default class UserValuation\r\n{\r\n  static getAccountValuation(array)\r\n  {\r\n    return array.sum > 0 ? array.sum : 0;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param state\r\n   * @return {number}\r\n   */\r\n  static getWholeActivesSum(state)\r\n  {\r\n    let sum = 0;\r\n\r\n    sum += InvestCalc.getValuation(state.invests);\r\n\r\n    return sum;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param state\r\n   * @return {number}\r\n   */\r\n  static getInvestActivesSum(state)\r\n  {\r\n    let sum = 0;\r\n\r\n    sum += InvestCalc.getValuation(state.invests);\r\n\r\n    return sum;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param managerId\r\n   * @param clientId\r\n   * @param currencyId\r\n   * @param accountBanks\r\n   * @param courses\r\n   * @param atonValuation\r\n   * @return {Promise<unknown>}\r\n   */\r\n  static async getInvestActivesValuation(managerId, clientId, currencyId, accountBanks = [], courses, atonValuation = false )\r\n  {\r\n    if(atonValuation)\r\n    {\r\n      return await (new Promise((resolve, reject) =>\r\n      {\r\n        Api.get('aton-portfolio', 'index')\r\n          .setDomain(process.env.REACT_APP_API_WHITESWAN_URL)\r\n          .where('user_id', clientId)\r\n          .all(({data}) =>\r\n          {\r\n            let sum = 0\r\n\r\n            data.map((row) => {\r\n              sum += row.score_position_rub;\r\n            })\r\n\r\n            resolve(sum)\r\n          })\r\n      }))\r\n    }else{\r\n      //если данные\r\n      var component = new ReactComponentEmulator();\r\n\r\n      component.state = {\r\n        accounts: [],\r\n        actives: [],\r\n        invests: [],\r\n        properties: [],\r\n        spendings: [],\r\n        obligations: [],\r\n\r\n        cashBalance: {\r\n          sum: 0\r\n        },\r\n        bankBalance: {\r\n          sum: 0\r\n        },\r\n        brokerBalance: {\r\n          sum: 0\r\n        },\r\n        digitBalance: {\r\n          sum: 0\r\n        }\r\n      }\r\n\r\n      let cachedValue = await IndexedDBCache.get('client.valuation.' + clientId)\r\n\r\n      if (cachedValue !== null)\r\n      {\r\n        return cachedValue;\r\n      } else\r\n      {\r\n        return await (new Promise((resolve, reject) =>\r\n        {\r\n          let now = moment();\r\n\r\n          let currencyData = {\r\n            currency_id: currencyId,\r\n            user_id: clientId\r\n          };\r\n\r\n          Active.getAccountsByDate(component, 'accounts', currencyData, clientId, accountBanks, now, () =>\r\n          {\r\n            Active.getInvestsByDate(component.state, [],'invests', currencyData, clientId, accountBanks, now, () =>\r\n            {\r\n              let valuation = UserValuation.getInvestActivesSum(component.state);\r\n\r\n              if(valuation > 0)\r\n              {\r\n                Cache.setItem('client.valuation.' + clientId, valuation)\r\n              }\r\n              resolve(valuation)\r\n            })\r\n          })\r\n        }))\r\n      }\r\n    }\r\n  }\r\n}"],"mappings":"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"}